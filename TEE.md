# TEE

可信执行环境TEE

### 可信执行环境TEE有5个技术概念：

- 1. Endorsement key 签注密钥
	
签注密钥必须随机生成，并且不能被改变。其中私钥安全保存，公钥用来认证和加密待发送的敏感数据。

- 2. Secure input and output 安全输入输出

用户和系统交互安全。

- 3. Memory curtaining 储存器屏蔽

安全独立的存储区域。

- 4. Sealed storage 密封存储

私有信息和平台环境配置信息捆绑，被密封存储的数据只能在相同的安全环境下读取。

- 5. Remote attestation 远程认证

签证密钥生成的软件证明书，远程授权方能感知和校验，从而使得系统的执行逻辑安全可信。

### 为什么要使用TEE

首先存储规则要是公开透明的，存储行为和结算都需要受到TEE的保护，节点无需担心存储了得不到回报，同时节点也无法欺骗全网获得收益。

数据的存储证明，本质就是节点提交一份可信的可被验证的存储报告，而有TEE的支持，节点只需要在n个区块间隔期间对已存储的文件对象进行Merkle Hash片段自抽查，并且在TEE内生成这样一份存储报告。节点附上自己的签名，让其他节点进行交叉验证即可。

TEE与节点身份（公钥）一一绑定，而存储区域可以只向TEE开放，这样保证数据存储的隔离安全，甚至隐私数据和敏感数据可以在TEE中进行加密封存。

矿工在接收用户文件后，在TEE内执行加密封装并保存，这样文件只有TEE可还原，这样可验证可信的处理过程，保证了数据存储只能是这个节点在处理，不会有女巫攻击。

### 节点需要在TEE环境中进行的验证工作

- 验证其他节点的TEE存储报告并上链。
- 验证网络中其他节点的TEE信息。

### 节点如何加入矿工网络

节点的TEE包含了验证节点的逻辑。而链上是维护了TEE节点的公钥证书，节点入网步骤如下：

- 拉取网络中现存节点的公钥及相关信息。
- 通过TEE的远程证明技术跟网络中的某个节点相互验证。
- 公布验证结果，其他节点对验证后打包上链生效。
- 抵押一定的代币。
- 提供本节点TEE生成的公钥，并写入链上。



### 节点的远程互相验证

- 节点身份
- 运营的逻辑未被篡改
- SGX平台上运行

### 远程认证流程

- 1. 链上随机挑选一对被验证者和验证者，验证着向被验证者提出证明请求，包括一个随机数防止重放攻击。
- 2. 被验证者节点收集芯片制造商的证书（Endorsement Key，EK）等信息用来标示节点的唯一身份，并用EK生成平台身份密钥（Application Identity Key，AIK）来避免暴露隐私，并将EK发送给隐私签署机构（Privacy Ceryification Agency，PCA）。
- 3. PCA通过验证EK，验证芯片合法性，并对AIK颁发证书。
- 4. 拿到证书的被验证节点通过引证（Quote）操作，使用AIK对软件度量值进行签名，并随之将签名值与度量日志和AIK证书发送给验证者。
- 5. 验证者首先验证AIK证书的有效性，使用AIK公钥对数据进行解密获取软件度量值，通过软件度量值确保度量日志可信地返回给了验证者，随后将度量日志的每一项与预期值进行比对，判断被验证节点是否可信。
- 6. 验证者将被验证者的AIK公钥写入区块链。

上面流程中1，2，3是初始化阶段，4，5是证明阶段。

AIK私钥保存在TEE的存储器屏蔽区，只能被TEE的可信执行程序安全访问。执行在节点TEE内的可信执行程序的运行结果，将会被AIK私钥签名，并且结果可以被链上的AIK公钥验证。


### 数据的存储证明

空盘证明不需要，如果节点不能负责有效的存储，进行处罚即可。

用户也不关心存储节点数据是如何获取的，只需要在规定时间内提交出存储报告即可。

存储节点需要在TEE中对数据做一个基础的报告，包括数据的hash摘要，Merkle Hash，size和随机抽查数据片段。

剩下的工作就是绑定的验证节点进行验证工作。










